@page "/login"
@inject NavigationManager Navigation
@using MauiBlazorHybrid.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthProvider
@using System.Security.Claims


<style>
    /* Contenedor principal */
    .container {
        max-width: 400px;
        margin: 130px auto;
        background: #ffff;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    /* Título */
    .form-title {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #333;
        letter-spacing: 1px;
    }

    /* Grupo de inputs */
    .form-group {
        margin-bottom: 1.2rem;
        text-align: left;
    }

    /* Etiquetas */
    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: #444;
    }

    /* Campos de texto */
    .form-input {
        width: 100%;
        padding: 0.7rem 1rem;
        background-color: #eaf3fc; /* azul muy claro, menos intenso */
        border: 1px solid #99c2eb; /* borde azul suave */
        color: #333;
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.3s, box-shadow 0.3s;
    }

        .form-input:focus {
            outline: none;
            border: 1px solid #0078d7;
            border-color: #3399ff; /* azul más vivo al enfocar */
            box-shadow: 0 0 4px rgba(51, 153, 255, 0.4);
            outline: none;
        }

    /* Botón */
    .form-button {
        width: 100%;
        padding: 0.8rem;
        background-color: #0078d7;
        color: #fff;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    }

        .form-button:hover {
            background-color: #005fa3;
        }

    /* Mensaje de error */
    .error-message {
        margin-top: 1rem;
        color: #d9534f;
        font-weight: 500;
        background: #fce4e4;
        padding: 0.6rem;
        border-radius: 6px;
    }
</style>
<div class="container" style="margin-top: 50px; margin-bottom: 50px;">
    <img src="img/logo_medigestormain.png" style="width:350px; height:150px;" />

        <div class="form-group">
            <label for="user" class="form-label">Usuario</label>
            <input type="text" id="user" autocomplete="off" class="form-input" @bind="nombre" placeholder="Nombre de usuario" required />
        </div>

        <div class="form-group password-container">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" id="password" autocomplete="off" class="form-input" @bind="contraseña" placeholder="Contraseña" required />
        </div>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">@errorMessage</div>
        }
        <br>
    <button type="submit" @onclick="Authenticate" class="form-button">Iniciar sesión</button>

    
</div>

@code {
    private string errorMessage = string.Empty;
    private string nombre = string.Empty;
    private string contraseña = string.Empty;
    /*private async Task Authenticate()
        {

        try
            {
            var usuario = await LoginService.ValidarRol(nombre, contraseña);

            if (usuario != null)
                {
                // Redirige según el rol detectado
                switch (usuario.Rol)
                    {
                        case "Admin":
                        Navigation.NavigateTo("/pacientes");
                    break;
                    case "Secretaria":
                        Navigation.NavigateTo("/citas");
                    break;
                        default:
                        Navigation.NavigateTo("/citas");
                break;
            }
            }
            else
                {
                errorMessage = "Credenciales incorrectas.";
        }
        }
        catch (Exception ex)
            {
            errorMessage = "Error inesperado al autenticar.";
            Console.WriteLine($"Error: {ex.Message}");
            }
    }*/

    private async Task Authenticate()
    {
        try
        {
            var ok = await AuthService.LoginAsync(nombre, contraseña);

            if (ok)
            {
                // Notifica a Blazor que el usuario está autenticado
                ((CustomAuthStateProvider)AuthProvider).NotifyLogin();

                // Obtiene el rol actual
                var authState = await AuthProvider.GetAuthenticationStateAsync();
                var rol = authState.User.FindFirst(c => c.Type == ClaimTypes.Role)?.Value;

                // Redirige según el rol
                switch (rol)
                {
                    case "Admin":
                        Navigation.NavigateTo("/citas");
                        break;
                    case "Secretario/a":
                        Navigation.NavigateTo("/pacientes");
                        break;
                    default:
                        Navigation.NavigateTo("/citas");
                        break;
                }
            }
            else
            {
                errorMessage = "Credenciales incorrectas.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error inesperado al autenticar.";
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

}